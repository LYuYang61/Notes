# 3、支持乱序执行的Raft协议
- 原文：[Notes/论文原文/3、支持乱序执行的Raft协议.pdf at master · LYuYang61/Notes · GitHub](https://github.com/LYuYang61/Notes/blob/master/%E8%AE%BA%E6%96%87%E5%8E%9F%E6%96%87/3%E3%80%81%E6%94%AF%E6%8C%81%E4%B9%B1%E5%BA%8F%E6%89%A7%E8%A1%8C%E7%9A%84Raft%E5%8D%8F%E8%AE%AE.pdf)
### 1、ParallelRaft-SE
#### 1.1 简介
- **目标**：在保持 Raft 易于理解和实现优点的基础上，允许日志条目乱序提交，从而提高系统吞吐量
- **背景**：
	- 传统的 Raft 协议在日志提交和执行上都具有严格的顺序性，这意味着一个日志条目必须等待所有序号小于它的日志条目都提交并应用后，才能被提交和应用
	- 这种强顺序性在高并发场景下会成为性能瓶颈
	- ParallelRaft-SE 旨在通过放宽“提交”的顺序性来提升并发度
- **与 Multi-Paxos 的关系**：
	- 论文通过建立从 ParallelRaft-SE 到 Multi-Paxos 的精化关系，证明了 ParallelRaft-SE 的正确性
	- 表明 ParallelRaft-SE 在**乱序提交、顺序执行**的特性上与 Multi-Paxos 有着逻辑上的等价性
#### 1.2 关键步骤
1. ​**​乱序日志接受与确认​**​：
    - ​​Leader ​​向 follower ​​并发发送​​多个日志多个日志条目，这些条目可以具有不连续的序号【无需等待前序项确认】
    - ​​Follower ​​收到日志条目后​​，只要自身日志中不冲突（例如，任期号更大），就可以立即接受并将其写入本地持久化存储，然后向 leader 发送确认​​【无论等待序号更小的日志条目】
2. **乱序提交**：
    - ​​当一个日志条目被多数 follower 确认（已持久化到磁盘）后，leader 可以立即将其标记为“已提交”，即使序号小于它的某些日志条目尚未被提交
	- **重要约束**：
		- ParallelRaft-SE 仍然要求**状态机按日志序号顺序执行**已提交的命令
		- 如果日志中存在空洞（即序号小的日志条目尚未提交，而序号大的日志条目已提交），那么序号大的日志条目将无法被应用，必须等待空洞被填补
3. ​**​选主机制​**​：
    - 沿用 Raft 的​​任期（Term）​​ 和​​多数派投票​​规则
    - 因日志可能存在空洞，​​无法直接比较日志新旧​​（需依赖后续日志恢复）
4. ​**​日志恢复​**​：
    - 新 Leader（候选节点）收集多数派节点的日志
    - 对缺失的日志项运行 ​​Paxos 实例​​重新确认（类似 Multi-Paxos）
    - 恢复后，新 Leader 日志补齐空洞，满足​​完全性​​（包含所有已提交日志）

### 2、ParallelRaft-CE
#### 2.1 简介
- **目标**：
	- 既支持 **乱序提交**，也允许 **乱序执行**
	- 在乱序执行中解决 **幽灵日志（Ghost Log）** 的一致性问题
- **幽灵日志**：可能会导致 leader 计算出的“向后看缓冲区“(LBF) 与实际不符
![image.png](https://qingwu-oss.oss-cn-heyuan.aliyuncs.com/lian/img/20250722104937.png)
#### 2.2 关键步骤
- **关键机制**：同步号 (sync)
	- 每个节点维护 sync 值，表示​**​当前可接受的日志任期**
	- 限制日志提交的并行度，多数节点确认后才能执行乱序执行，避免幽灵日志带来的一致性破坏
1. ​**​选主与恢复​**​：
    - 候选节点通过​**​比较同步号​**​赢得选举（高 sync 值优先）
    - 尚未完成日志恢复的 leader 称为 ​**​leader candidate​**​，同步号 s < 任期 t（系统内不存在任期大于 s 的日志项）
    - ​**​恢复目标​**​：补齐任期 s 的日志项（系统内不存在任期大于 s 的日志项）
    - **恢复方法**：从多数派节点收集日志项，并从中选择最“新”的日志项（日志编号相同，日期 date 越大的日志项就越“新”）
2. ​**​三阶段日志恢复​**​：
    - ​**​阶段1（follower sync < s）​**​：  
        Leader candidate 向 follower 发送任期 = sync 的日志 → follower 确认 → leader 通知升级 sync 至下一个同步号 k，循环上述过程，直至到阶段2
    - ​**​阶段2（follower sync = s）​**​：  
        Leader candidate 向 follower 发送任期 = s 的日志 → 多数派确认后提交，进入阶段3
    - ​**​阶段3（follower sync > s）​**​：  
        Leader candidate 将自身 sync 升级至任期 t → 通知多数派节点升级 sync 至 t → 收到某多数派节点的确认消息后，恢复过程结束，正式成为主节点
3. ​**​Leader 正式工作​**​：
    - 自身及多数派节点 sync = t 后成为正式 Leader
    - ​**​乱序执行​**​：根据 LBA 冲突检测，无冲突命令可并行执行

### ​​3、协议对比总结​​

| 方案         | Multi-Paxos | Raft      | ParallelRaft-CE   |
| ---------- | ----------- | --------- | ----------------- |
| **核心思想**   | 栅栏日志+生成时间检测 | 选主时删除冲突日志 | 同步号（Sync） + 三阶段同步 |
| **实现方式**   | 被动检测        | 主动删除      | 三阶段恢复             |
| **乱序提交支持** | ✔️          | ❌         | ✔️                |
| **乱序执行支持** | ❌           | ❌         | ✔️                |
| **解决幽灵日志** | ❌（乱序下无效）    | ✔️        | ✔️                |

| ​​特性​​         | ​​ParallelRaft-SE​​ | ​​ParallelRaft-CE​​ |
| -------------- | ------------------- | ------------------- |
| **​​提交方式​​**   | 乱序提交                | 乱序提交                |
| **​​执行方式​​**   | 顺序执行                | 乱序执行（无冲突命令）         |
| **​​核心机制​​**   | 日志恢复（Paxos 重确认）     | 同步号（Sync） + 三阶段同步   |
| **​​解决幽灵日志**​​ | ❌（顺序执行下不影响正确性）      | ✔️（限制并行度 + 同步号屏障）   |
| **​​适用场景​​**   | 理论过渡模型              | 高并发系统（如 PolarFS）    |
